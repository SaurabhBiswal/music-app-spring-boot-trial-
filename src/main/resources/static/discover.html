<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Music - MusicHub Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS from previous version - enhanced with new features */
        /* Add to existing CSS */
        
        .feature-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        
        .rating-stars {
            color: #FFD700;
            font-size: 14px;
        }
        
        .social-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }
        
        .social-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .offline-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #1db954;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .import-badge {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .share-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .share-options {
            display: none;
            position: absolute;
            background: rgba(0,0,0,0.9);
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;
            min-width: 150px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .share-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .share-option:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Podcast specific styles */
        .podcast-card {
            background: linear-gradient(135deg, #8A2BE2, #4B0082);
        }
        
        .episode-duration {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        /* Recommendation section */
        .recommendation-reason {
            color: #1db954;
            font-style: italic;
            font-size: 13px;
            margin-top: 5px;
        }
        
        /* Filter panel */
        .filter-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 8px;
            color: #b3b3b3;
            font-size: 14px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
        }
        
        /* Import service icons */
        .service-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .spotify-bg { background: #1DB954; }
        .youtube-bg { background: #FF0000; }
        .apple-bg { background: #FA243C; }
        .soundcloud-bg { background: #FF3300; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Discover Music Pro</h1>
            <p class="subtitle">
                Explore millions of songs, podcasts, and playlists. Get personalized recommendations,
                import from other services, and enjoy music offline!
            </p>
            
            <div class="nav-links">
                <a href="/" class="nav-btn">üè† Home</a>
                <a href="/music-player.html" class="nav-btn">üéß Player</a>
                <a href="/discover.html" class="nav-btn active">üîç Discover</a>
                <a href="/podcast.html" class="nav-btn">üéô Podcasts</a>
                <a href="/recommendations.html" class="nav-btn">‚ú® Recommendations</a>
                <a href="/social.html" class="nav-btn">üë• Social</a>
                <a href="/import.html" class="nav-btn">üì• Import</a>
                <a href="/offline.html" class="nav-btn">üíæ Offline</a>
            </div>
        </header>
        
        <!-- Advanced Search Section -->
        <div class="search-section">
            <h2 style="color: #1db954; margin-bottom: 20px;">
                <i class="fas fa-search-plus"></i> Advanced Music Search
            </h2>
            
            <div class="search-box">
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       placeholder="Search songs, artists, albums, podcasts..."
                       onkeypress="if(event.keyCode==13) searchMusic()">
                <button class="search-btn" onclick="searchMusic()">
                    <i class="fas fa-search"></i> Search
                </button>
                <button class="search-btn" onclick="showAdvancedFilters()" 
                        style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="filterPanel" class="filter-panel" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="filter-group">
                        <label class="filter-label"><i class="fas fa-music"></i> Genre</label>
                        <select id="genreFilter" class="filter-select">
                            <option value="">All Genres</option>
                            <option value="pop">Pop</option>
                            <option value="rock">Rock</option>
                            <option value="hiphop">Hip-Hop</option>
                            <option value="jazz">Jazz</option>
                            <option value="classical">Classical</option>
                            <option value="electronic">Electronic</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label"><i class="fas fa-calendar"></i> Year</label>
                        <select id="yearFilter" class="filter-select">
                            <option value="">Any Year</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2010-2019">2010s</option>
                            <option value="2000-2009">2000s</option>
                            <option value="1990-1999">90s</option>
                            <option value="1980-1989">80s</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label"><i class="fas fa-sort"></i> Sort By</label>
                        <select id="sortFilter" class="filter-select">
                            <option value="relevance">Relevance</option>
                            <option value="popularity">Popularity</option>
                            <option value="rating">Rating</option>
                            <option value="newest">Newest</option>
                            <option value="duration">Duration</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label"><i class="fas fa-database"></i> Source</label>
                        <select id="sourceFilter" class="filter-select">
                            <option value="">All Sources</option>
                            <option value="musicbrainz">MusicBrainz</option>
                            <option value="youtube">YouTube</option>
                            <option value="spotify">Spotify</option>
                            <option value="podcast">Podcasts</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="search-btn" onclick="applyFilters()" 
                            style="flex: 1; background: linear-gradient(135deg, #1db954, #1ed760);">
                        <i class="fas fa-check"></i> Apply Filters
                    </button>
                    <button class="search-btn" onclick="resetFilters()" 
                            style="background: rgba(255,255,255,0.1);">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('trending')">
                    <i class="fas fa-fire"></i> Trending
                </button>
                <button class="tab-btn" onclick="showTab('recommendations')">
                    <i class="fas fa-magic"></i> For You
                </button>
                <button class="tab-btn" onclick="showTab('podcasts')">
                    <i class="fas fa-podcast"></i> Podcasts
                </button>
                <button class="tab-btn" onclick="showTab('genres')">
                    <i class="fas fa-guitar"></i> Genres
                </button>
                <button class="tab-btn" onclick="showTab('offline')">
                    <i class="fas fa-download"></i> Offline
                </button>
                <button class="tab-btn" onclick="showTab('import')">
                    <i class="fas fa-cloud-download-alt"></i> Import
                </button>
            </div>
            
            <!-- Status Messages -->
            <div id="status" class="status" style="display: none;"></div>
            
            <!-- Loading Spinner -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading music data...</p>
            </div>
            
            <!-- Music Grid -->
            <div id="musicContainer" class="music-grid">
                <!-- Dynamic content loaded here -->
            </div>
            
            <!-- Pagination -->
            <div id="pagination" style="display: none; margin-top: 30px; text-align: center;">
                <button id="prevBtn" class="nav-btn" onclick="prevPage()">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="pageInfo" style="margin: 0 15px; color: #b3b3b3;"></span>
                <button id="nextBtn" class="nav-btn" onclick="nextPage()">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Features Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 40px;">
            <div style="background: rgba(29, 185, 84, 0.1); padding: 20px; border-radius: 15px; border: 1px solid rgba(29, 185, 84, 0.3);">
                <h3 style="color: #1db954;"><i class="fas fa-robot"></i> AI Recommendations</h3>
                <p>Get personalized music recommendations based on your listening history and preferences.</p>
                <button class="nav-btn" onclick="getRecommendations()" 
                        style="margin-top: 10px; background: rgba(29, 185, 84, 0.2);">
                    Get Recommendations
                </button>
            </div>
            
            <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 15px; border: 1px solid rgba(102, 126, 234, 0.3);">
                <h3 style="color: #667eea;"><i class="fas fa-headphones"></i> Podcast Discovery</h3>
                <p>Explore thousands of podcasts across all categories. Subscribe and listen offline.</p>
                <button class="nav-btn" onclick="showTab('podcasts')" 
                        style="margin-top: 10px; background: rgba(102, 126, 234, 0.2);">
                    Browse Podcasts
                </button>
            </div>
            
            <div style="background: rgba(255, 107, 107, 0.1); padding: 20px; border-radius: 15px; border: 1px solid rgba(255, 107, 107, 0.3);">
                <h3 style="color: #FF6B6B;"><i class="fas fa-cloud-download-alt"></i> Import Music</h3>
                <p>Import your playlists from Spotify, YouTube, Apple Music and other services.</p>
                <button class="nav-btn" onclick="window.location.href='/import.html'" 
                        style="margin-top: 10px; background: rgba(255, 107, 107, 0.2);">
                    Import Now
                </button>
            </div>
            
            <div style="background: rgba(251, 86, 7, 0.1); padding: 20px; border-radius: 15px; border: 1px solid rgba(251, 86, 7, 0.3);">
                <h3 style="color: #FB5607;"><i class="fas fa-download"></i> Offline Mode</h3>
                <p>Download your favorite tracks and podcasts for offline listening anywhere.</p>
                <button class="nav-btn" onclick="showTab('offline')" 
                        style="margin-top: 10px; background: rgba(251, 86, 7, 0.2);">
                    Go Offline
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Audio Player -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script>
        // Enhanced JavaScript with all new features
        let currentTab = 'trending';
        let currentResults = [];
        let currentPage = 0;
        const pageSize = 20;
        let totalResults = 0;
        let currentFilters = {};
        let userId = localStorage.getItem('userId') || '1'; // For demo
        
        // Load trending music on page load
        window.onload = function() {
            loadTrendingMusic();
            checkUserId();
        };
        
        // Check if user is logged in
        function checkUserId() {
            if (!userId) {
                showStatus('You are in guest mode. Some features may be limited.', 'info');
                document.getElementById('userIdDisplay').textContent = 'Guest';
            } else {
                document.getElementById('userIdDisplay').textContent = 'User #' + userId;
            }
        }
        
        // Show advanced filters
        function showAdvancedFilters() {
            const panel = document.getElementById('filterPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Apply filters
        function applyFilters() {
            currentFilters = {
                genre: document.getElementById('genreFilter').value,
                year: document.getElementById('yearFilter').value,
                sort: document.getElementById('sortFilter').value,
                source: document.getElementById('sourceFilter').value
            };
            
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                searchMusic();
            } else {
                loadTrendingMusic();
            }
            
            document.getElementById('filterPanel').style.display = 'none';
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('genreFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('sortFilter').value = 'relevance';
            document.getElementById('sourceFilter').value = '';
            currentFilters = {};
            
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                searchMusic();
            } else {
                loadTrendingMusic();
            }
            
            document.getElementById('filterPanel').style.display = 'none';
        }
        
        // Enhanced search music
        async function searchMusic() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                showStatus('Please enter a search term', 'error');
                return;
            }
            
            showLoading(true);
            showStatus(`Searching for "${query}" with filters...`, 'info');
            
            try {
                const params = new URLSearchParams({
                    query: query,
                    limit: pageSize,
                    page: currentPage,
                    ...currentFilters
                });
                
                const response = await fetch(`/api/discover/search?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    currentResults = result.data;
                    totalResults = result.total || currentResults.length;
                    displayMusic(currentResults);
                    updatePagination();
                    showStatus(`Found ${totalResults} results for "${query}"`, 'success');
                } else {
                    showStatus(`Search failed: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Load trending music
        async function loadTrendingMusic() {
            showLoading(true);
            showStatus('Loading trending music...', 'info');
            
            try {
                const response = await fetch(`/api/discover/trending?userId=${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentResults = result.data;
                    displayMusic(currentResults);
                    showStatus('Loaded trending music', 'success');
                } else {
                    showStatus(`Failed to load trending music: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Get personalized recommendations
        async function getRecommendations() {
            showLoading(true);
            showStatus('Getting personalized recommendations...', 'info');
            
            try {
                const response = await fetch(`/api/discover/recommendations?userId=${userId}&limit=10`);
                const result = await response.json();
                
                if (result.success) {
                    currentResults = result.data.recommendations;
                    displayMusic(currentResults, 'recommendation');
                    showStatus(result.data.explanation, 'success');
                } else {
                    showStatus(`Failed to get recommendations: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Display music with enhanced features
        function displayMusic(musicList, type = 'music') {
            const container = document.getElementById('musicContainer');
            container.innerHTML = '';
            
            if (!musicList || musicList.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #b3b3b3;">
                        <i class="fas fa-music" style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3 style="margin-bottom: 10px;">No music found</h3>
                        <p>Try searching for something else or check back later.</p>
                    </div>
                `;
                return;
            }
            
            musicList.forEach((track, index) => {
                const musicCard = document.createElement('div');
                musicCard.className = 'music-card';
                
                // Add podcast styling
                if (track.source === 'podcast' || track.type === 'podcast') {
                    musicCard.classList.add('podcast-card');
                }
                
                // Format duration
                const duration = track.duration || 180;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const formattedDuration = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Get album art
                const albumArt = track.albumArt || 'https://via.placeholder.com/300/1db954/ffffff?text=Music';
                const albumArtLarge = track.albumArtLarge || albumArt;
                
                // Generate rating stars
                const rating = track.averageRating || 4.0;
                const ratingStars = generateStarRating(rating);
                
                // Generate social stats
                const socialStats = generateSocialStats(track);
                
                // Generate feature badges
                const featureBadges = generateFeatureBadges(track);
                
                musicCard.innerHTML = `
                    <div class="album-art">
                        <img src="${albumArt}" alt="${track.title || 'Album Art'}" 
                             onerror="this.src='https://via.placeholder.com/300/1db954/ffffff?text=Music'">
                        
                        ${track.isOfflineAvailable ? 
                            `<div class="offline-badge">
                                <i class="fas fa-download"></i> Offline
                            </div>` : ''}
                        
                        ${track.imported ? 
                            `<div class="import-badge">
                                <i class="fas fa-cloud-download-alt"></i> Imported
                            </div>` : ''}
                        
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 20px; font-size: 12px;">
                            ${formattedDuration}
                        </div>
                    </div>
                    
                    <div class="music-info">
                        <div class="music-title" title="${track.title || 'Unknown Track'}">
                            ${track.title || 'Unknown Track'}
                            ${featureBadges}
                        </div>
                        
                        <div class="music-artist" title="${track.artist || 'Unknown Artist'}">
                            ${track.artist || 'Unknown Artist'}
                        </div>
                        
                        <div style="color: #888; font-size: 0.9rem; margin-bottom: 5px;">
                            ${track.album || 'Unknown Album'}
                        </div>
                        
                        ${ratingStars}
                        
                        ${socialStats}
                        
                        ${track.recommendationReason ? 
                            `<div class="recommendation-reason">
                                <i class="fas fa-lightbulb"></i> ${track.recommendationReason}
                            </div>` : ''}
                        
                        <div class="music-meta">
                            <span>${track.year || track.releaseDate || 'Unknown'}</span>
                            <span>${track.source || 'Unknown Source'}</span>
                        </div>
                        
                        <div class="music-actions">
                            <button class="action-btn play-btn" onclick="playTrack(${index})">
                                <i class="fas fa-play"></i> Play
                            </button>
                            
                            <div class="share-dropdown">
                                <button class="action-btn add-btn" onclick="toggleShareDropdown(${index})">
                                    <i class="fas fa-share-alt"></i> Share
                                </button>
                                <div id="shareDropdown${index}" class="share-options">
                                    <a href="#" class="share-option" onclick="shareOnFacebook('${track.id}', '${track.title}')">
                                        <i class="fab fa-facebook" style="color: #1877F2;"></i> Facebook
                                    </a>
                                    <a href="#" class="share-option" onclick="shareOnTwitter('${track.id}', '${track.title}')">
                                        <i class="fab fa-twitter" style="color: #1DA1F2;"></i> Twitter
                                    </a>
                                    <a href="#" class="share-option" onclick="copyShareLink('${track.id}')">
                                        <i class="fas fa-link"></i> Copy Link
                                    </a>
                                </div>
                            </div>
                            
                            ${!track.isOfflineAvailable ? 
                                `<button class="action-btn add-btn" onclick="saveForOffline(${index})">
                                    <i class="fas fa-download"></i> Save
                                </button>` : ''}
                            
                            <button class="action-btn add-btn" onclick="rateTrack(${index})">
                                <i class="fas fa-star"></i> Rate
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(musicCard);
            });
        }
        
        // Generate star rating HTML
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let stars = '';
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            
            return `<div class="rating-stars">${stars} ${rating.toFixed(1)}</div>`;
        }
        
        // Generate social stats HTML
        function generateSocialStats(track) {
            const likes = track.likes || 0;
            const shares = track.shares || 0;
            const comments = track.comments || 0;
            const playCount = track.playCount || 0;
            
            return `
                <div class="social-stats">
                    <div class="social-stat">
                        <i class="fas fa-heart"></i> ${formatNumber(likes)}
                    </div>
                    <div class="social-stat">
                        <i class="fas fa-share"></i> ${formatNumber(shares)}
                    </div>
                    <div class="social-stat">
                        <i class="fas fa-comment"></i> ${formatNumber(comments)}
                    </div>
                    <div class="social-stat">
                        <i class="fas fa-play"></i> ${formatNumber(playCount)}
                    </div>
                </div>
            `;
        }
        
        // Generate feature badges
        function generateFeatureBadges(track) {
            let badges = '';
            
            if (track.source === 'YouTube') {
                badges += '<span class="feature-badge"><i class="fab fa-youtube"></i> YouTube</span>';
            }
            
            if (track.recommended) {
                badges += '<span class="feature-badge"><i class="fas fa-magic"></i> Recommended</span>';
            }
            
            if (track.podcast) {
                badges += '<span class="feature-badge"><i class="fas fa-podcast"></i> Podcast</span>';
            }
            
            if (track.imported) {
                badges += '<span class="feature-badge"><i class="fas fa-cloud-download-alt"></i> Imported</span>';
            }
            
            return badges;
        }
        
        // Format large numbers
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num;
        }
        
        // Play track
        async function playTrack(index) {
            const track = currentResults[index];
            
            // Record play history
            if (userId) {
                await fetch('/api/discover/play', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': userId
                    },
                    body: JSON.stringify({
                        audioId: track.id,
                        duration: track.duration || 180
                    })
                });
            }
            
            // Get audio URL (prefer offline if available)
            let audioUrl;
            if (track.isOfflineAvailable) {
                const response = await fetch(`/api/cache/offline/audio/${track.id}`);
                const result = await response.json();
                if (result.success) {
                    audioUrl = result.data.path;
                }
            }
            
            if (!audioUrl) {
                // Use first available audio source
                if (track.audioSources && track.audioSources.length > 0) {
                    audioUrl = track.audioSources[0].url;
                } else {
                    audioUrl = track.sampleAudioUrl;
                }
            }
            
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = audioUrl;
            audioPlayer.play();
            
            showStatus(`Now playing: ${track.title}`, 'success');
        }
        
        // Save track for offline
        async function saveForOffline(index) {
            const track = currentResults[index];
            showStatus(`Saving "${track.title}" for offline...`, 'info');
            
            try {
                const response = await fetch('/api/cache/offline/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(track)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`"${track.title}" saved for offline playback`, 'success');
                    track.isOfflineAvailable = true;
                    
                    // Update UI
                    const cards = document.querySelectorAll('.music-card');
                    if (cards[index]) {
                        const albumArt = cards[index].querySelector('.album-art');
                        if (albumArt) {
                            albumArt.insertAdjacentHTML('afterbegin',
                                `<div class="offline-badge">
                                    <i class="fas fa-download"></i> Offline
                                </div>`
                            );
                        }
                    }
                } else {
                    showStatus(`Failed to save: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Rate track
        async function rateTrack(index) {
            const track = currentResults[index];
            const rating = prompt(`Rate "${track.title}" (1-5 stars):`, '5');
            
            if (rating && rating >= 1 && rating <= 5) {
                const review = prompt('Add a review (optional):');
                const reviewTitle = prompt('Review title (optional):');
                
                showStatus(`Submitting rating for "${track.title}"...`, 'info');
                
                try {
                    const response = await fetch('/api/social/ratings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': userId
                        },
                        body: JSON.stringify({
                            trackId: track.id,
                            rating: parseFloat(rating),
                            review: review || '',
                            reviewTitle: reviewTitle || ''
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('Rating submitted successfully!', 'success');
                    } else {
                        showStatus(`Failed: ${result.message}`, 'error');
                    }
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            }
        }
        
        // Share on Facebook
        function shareOnFacebook(trackId, title) {
            const url = `https://musicapp.com/track/${trackId}`;
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(title)}`;
            window.open(shareUrl, '_blank');
        }
        
        // Share on Twitter
        function shareOnTwitter(trackId, title) {
            const url = `https://musicapp.com/track/${trackId}`;
            const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank');
        }
        
        // Copy share link
        function copyShareLink(trackId) {
            const url = `https://musicapp.com/track/${trackId}`;
            navigator.clipboard.writeText(url);
            showStatus('Link copied to clipboard!', 'success');
        }
        
        // Toggle share dropdown
        function toggleShareDropdown(index) {
            const dropdown = document.getElementById(`shareDropdown${index}`);
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }
        
        // Close all share dropdowns
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.share-dropdown')) {
                document.querySelectorAll('.share-options').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (totalResults > pageSize) {
                pagination.style.display = 'block';
                const totalPages = Math.ceil(totalResults / pageSize);
                pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
                
                prevBtn.disabled = currentPage === 0;
                nextBtn.disabled = currentPage >= totalPages - 1;
            } else {
                pagination.style.display = 'none';
            }
        }
        
        // Next page
        function nextPage() {
            if (currentPage < Math.ceil(totalResults / pageSize) - 1) {
                currentPage++;
                searchMusic();
            }
        }
        
        // Previous page
        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                searchMusic();
            }
        }
        
        // Tab switching
        function showTab(tabName) {
            currentTab = tabName;
            currentPage = 0;
            
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load appropriate content
            switch (tabName) {
                case 'trending':
                    loadTrendingMusic();
                    break;
                case 'recommendations':
                    getRecommendations();
                    break;
                case 'podcasts':
                    loadPodcasts();
                    break;
                case 'genres':
                    loadGenres();
                    break;
                case 'offline':
                    loadOfflineTracks();
                    break;
                case 'import':
                    loadImportServices();
                    break;
            }
        }
        
        // Load podcasts
        async function loadPodcasts() {
            showLoading(true);
            showStatus('Loading podcasts...', 'info');
            
            try {
                const response = await fetch('/api/podcasts/search?query=technology&limit=12');
                const result = await response.json();
                
                if (result.success) {
                    currentResults = result.data;
                    displayMusic(currentResults);
                    showStatus('Loaded podcasts', 'success');
                } else {
                    showStatus(`Failed to load podcasts: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Load genres
        async function loadGenres() {
            showLoading(true);
            showStatus('Loading genres...', 'info');
            
            try {
                const response = await fetch('/api/discover/genres');
                const result = await response.json();
                
                if (result.success) {
                    displayGenres(result.data);
                    showStatus('Loaded genres', 'success');
                } else {
                    showStatus(`Failed to load genres: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Display genres
        function displayGenres(genres) {
            const container = document.getElementById('musicContainer');
            container.innerHTML = '';
            
            genres.forEach(genre => {
                const genreCard = document.createElement('div');
                genreCard.className = 'music-card';
                genreCard.style.background = `linear-gradient(135deg, ${genre.color}, ${genre.color}80)`;
                
                genreCard.innerHTML = `
                    <div class="album-art" style="background: transparent; font-size: 40px;">
                        <i class="fas fa-guitar"></i>
                    </div>
                    <div class="music-info">
                        <div class="music-title">${genre.name}</div>
                        <div style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">
                            ${genre.trackCount.toLocaleString()} tracks
                        </div>
                        <div class="music-actions">
                            <button class="action-btn play-btn" onclick="searchGenre('${genre.id}')">
                                <i class="fas fa-play"></i> Explore
                            </button>
                            <button class="action-btn add-btn" onclick="getGenreRecommendations('${genre.id}')">
                                <i class="fas fa-star"></i> Top Picks
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(genreCard);
            });
        }
        
        // Search by genre
        function searchGenre(genreId) {
            document.getElementById('genreFilter').value = genreId;
            applyFilters();
        }
        
        // Get genre recommendations
        async function getGenreRecommendations(genreId) {
            showLoading(true);
            
            try {
                const response = await fetch(`/api/discover/trending?genre=${genreId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentResults = result.data;
                    displayMusic(currentResults);
                    showStatus(`Top ${genreId} tracks`, 'success');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Load offline tracks
        async function loadOfflineTracks() {
            showLoading(true);
            showStatus('Loading offline tracks...', 'info');
            
            try {
                const response = await fetch('/api/cache/offline/tracks');
                const result = await response.json();
                
                if (result.success) {
                    // For demo, create mock tracks from IDs
                    const offlineTracks = result.data.map(trackId => ({
                        id: trackId,
                        title: `Offline Track ${trackId.substring(0, 8)}`,
                        artist: 'Local Artist',
                        album: 'Offline Collection',
                        duration: 180,
                        isOfflineAvailable: true,
                        source: 'Offline'
                    }));
                    
                    currentResults = offlineTracks;
                    displayMusic(currentResults);
                    showStatus(`Loaded ${offlineTracks.length} offline tracks`, 'success');
                } else {
                    showStatus(`Failed to load offline tracks: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Load import services
        async function loadImportServices() {
            showLoading(true);
            showStatus('Loading import services...', 'info');
            
            try {
                const response = await fetch('/api/import/services');
                const result = await response.json();
                
                if (result.success) {
                    displayImportServices(result.data);
                    showStatus('Loaded import services', 'success');
                } else {
                    showStatus(`Failed to load services: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Display import services
        function displayImportServices(services) {
            const container = document.getElementById('musicContainer');
            container.innerHTML = '';
            
            services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'music-card';
                serviceCard.style.background = `linear-gradient(135deg, ${service.color}40, ${service.color}20)`;
                
                serviceCard.innerHTML = `
                    <div class="album-art" style="background: transparent; font-size: 40px; color: ${service.color}">
                        <i class="${service.icon}"></i>
                    </div>
                    <div class="music-info">
                        <div class="music-title">${service.name}</div>
                        <div style="color: #888; margin-bottom: 10px;">
                            ${service.connected ? 
                                `<span style="color: #1db954;"><i class="fas fa-check-circle"></i> Connected</span>` :
                                `<span style="color: #dc3545;"><i class="fas fa-times-circle"></i> Not Connected</span>`
                            }
                            <br>
                            ${service.importCount} tracks imported
                        </div>
                        <div class="music-actions">
                            ${service.connected ? 
                                `<button class="action-btn play-btn" onclick="importFromService('${service.id}')">
                                    <i class="fas fa-download"></i> Import
                                </button>
                                <button class="action-btn add-btn" onclick="disconnectService('${service.id}')">
                                    <i class="fas fa-unlink"></i> Disconnect
                                </button>` :
                                `<button class="action-btn play-btn" onclick="connectService('${service.id}')">
                                    <i class="fas fa-link"></i> Connect
                                </button>`
                            }
                        </div>
                    </div>
                `;
                
                container.appendChild(serviceCard);
            });
        }
        
        // Connect service
        function connectService(serviceId) {
            const apiKey = prompt(`Enter your ${serviceId} API Key:`);
            if (apiKey) {
                showStatus(`Connecting to ${serviceId}...`, 'info');
                
                // In production, make API call
                setTimeout(() => {
                    showStatus(`Connected to ${serviceId}`, 'success');
                    loadImportServices();
                }, 1000);
            }
        }
        
        // Import from service
        function importFromService(serviceId) {
            const playlistId = prompt(`Enter ${serviceId} playlist ID or URL:`);
            if (playlistId) {
                showStatus(`Importing from ${serviceId}...`, 'info');
                
                // In production, make API call
                setTimeout(() => {
                    showStatus(`Imported playlist from ${serviceId}`, 'success');
                }, 2000);
            }
        }
        
        // Helper functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Add event listener for Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });
        
        // Show popular searches
        const popularSearches = ['rock', 'jazz', 'pop', 'classical', 'electronic', 'podcast', '2023'];
        setTimeout(() => {
            const suggestions = document.createElement('div');
            suggestions.innerHTML = `
                <div style="margin-top: 20px; color: #b3b3b3;">
                    <strong>Try searching for:</strong>
                    ${popularSearches.map(term => 
                        `<span style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px; margin: 0 5px; cursor: pointer;" 
                              onclick="document.getElementById('searchInput').value='${term}'; searchMusic()">
                            ${term}
                         </span>`
                    ).join(' ')}
                </div>
            `;
            document.querySelector('.search-section').appendChild(suggestions);
        }, 1000);
    </script>
</body>
</html>