<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendations - MusicHub Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            background: linear-gradient(90deg, #00DBDE, #FC00FF);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .nav-btn:hover {
            background: rgba(0, 219, 222, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #00DBDE, #FC00FF);
        }
        
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00DBDE, #FC00FF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }
        
        .user-info h3 {
            margin-bottom: 5px;
            font-size: 1.5rem;
        }
        
        .user-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00DBDE;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #888;
        }
        
        /* Recommendation Sections */
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #00DBDE;
        }
        
        .section-subtitle {
            color: #888;
            margin-bottom: 20px;
        }
        
        /* Music Grid */
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .music-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .music-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 219, 222, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .album-art {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #00DBDE, #FC00FF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: relative;
            overflow: hidden;
        }
        
        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .recommendation-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 219, 222, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .music-info {
            padding: 20px;
        }
        
        .music-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .music-artist {
            color: #b3b3b3;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .recommendation-reason {
            color: #00DBDE;
            font-style: italic;
            font-size: 0.9rem;
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .confidence-score {
            display: inline-block;
            background: rgba(0, 219, 222, 0.2);
            color: #00DBDE;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        .music-meta {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 0.9rem;
            margin-top: 15px;
        }
        
        .music-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #00DBDE, #FC00FF);
            color: white;
        }
        
        .play-btn:hover {
            background: linear-gradient(135deg, #FC00FF, #00DBDE);
            transform: scale(1.05);
        }
        
        .add-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .add-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .filter-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, #00DBDE, #FC00FF);
            border-color: transparent;
        }
        
        /* Mood Selector */
        .mood-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .mood-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mood-btn:hover {
            transform: translateY(-2px);
        }
        
        .mood-btn.active {
            background: linear-gradient(135deg, #00DBDE, #FC00FF);
            border-color: transparent;
        }
        
        /* Status Messages */
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .success {
            background: rgba(0, 219, 222, 0.2);
            color: #00DBDE;
            border: 1px solid rgba(0, 219, 222, 0.3);
        }
        
        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .info {
            background: rgba(13, 110, 253, 0.2);
            color: #0d6efd;
            border: 1px solid rgba(13, 110, 253, 0.3);
        }
        
        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #b3b3b3;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00DBDE;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .user-profile {
                flex-direction: column;
                text-align: center;
            }
            
            .user-stats {
                justify-content: center;
            }
            
            .music-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .filter-tabs, .mood-selector {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ú® Your Recommendations</h1>
            <p class="subtitle">
                Discover music tailored just for you! Based on your listening history, ratings, and preferences.
                The more you listen, the better your recommendations become.
            </p>
            
            <div class="nav-links">
                <a href="/" class="nav-btn">üè† Home</a>
                <a href="/music-player.html" class="nav-btn">üéß Music Player</a>
                <a href="/discover.html" class="nav-btn">üîç Discover</a>
                <a href="/podcast.html" class="nav-btn">üéô Podcasts</a>
                <a href="/recommendations.html" class="nav-btn active">‚ú® Recommendations</a>
                <a href="/social.html" class="nav-btn">üë• Social</a>
                <a href="/import.html" class="nav-btn">üì• Import</a>
                <a href="/offline.html" class="nav-btn">üíæ Offline</a>
            </div>
        </header>
        
        <!-- User Profile -->
        <div class="user-profile">
            <div class="avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-info">
                <h3 id="username">Music Explorer</h3>
                <p id="userBio">Lover of all things music. Always discovering new sounds.</p>
                <div class="user-stats">
                    <div class="stat">
                        <div class="stat-value" id="playCount">0</div>
                        <div class="stat-label">Plays</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="trackCount">0</div>
                        <div class="stat-label">Tracks</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="ratingCount">0</div>
                        <div class="stat-label">Ratings</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="daysActive">1</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                </div>
            </div>
            <div style="margin-left: auto;">
                <button class="nav-btn" onclick="refreshRecommendations()" 
                        style="background: linear-gradient(135deg, #00DBDE, #FC00FF);">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        
        <!-- Mood Selector -->
        <div class="section">
            <h3 style="color: #00DBDE; margin-bottom: 15px;">
                <i class="fas fa-smile"></i> What's your mood?
            </h3>
            <div class="mood-selector">
                <button class="mood-btn active" onclick="filterByMood('all')">
                    <i class="fas fa-compass"></i> All
                </button>
                <button class="mood-btn" onclick="filterByMood('happy')">
                    <i class="fas fa-laugh"></i> Happy
                </button>
                <button class="mood-btn" onclick="filterByMood('energetic')">
                    <i class="fas fa-bolt"></i> Energetic
                </button>
                <button class="mood-btn" onclick="filterByMood('relaxed')">
                    <i class="fas fa-spa"></i> Relaxed
                </button>
                <button class="mood-btn" onclick="filterByMood('focused')">
                    <i class="fas fa-brain"></i> Focused
                </button>
                <button class="mood-btn" onclick="filterByMood('romantic')">
                    <i class="fas fa-heart"></i> Romantic
                </button>
                <button class="mood-btn" onclick="filterByMood('workout')">
                    <i class="fas fa-dumbbell"></i> Workout
                </button>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="status" class="status" style="display: none;"></div>
        
        <!-- Loading Spinner -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing your taste and finding perfect recommendations...</p>
        </div>
        
        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" onclick="showSection('personalized')">
                <i class="fas fa-user-check"></i> Personalized
            </button>
            <button class="filter-tab" onclick="showSection('newReleases')">
                <i class="fas fa-star"></i> New Releases
            </button>
            <button class="filter-tab" onclick="showSection('basedOnHistory')">
                <i class="fas fa-history"></i> Based on History
            </button>
            <button class="filter-tab" onclick="showSection('similarArtists')">
                <i class="fas fa-users"></i> Similar Artists
            </button>
            <button class="filter-tab" onclick="showSection('trending')">
                <i class="fas fa-fire"></i> Trending
            </button>
        </div>
        
        <!-- Personalized Recommendations -->
        <div id="personalizedSection" class="section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-magic"></i> Made For You
                </h2>
                <div class="section-subtitle" id="personalizedExplanation">
                    Based on your recent listening activity
                </div>
            </div>
            
            <div id="personalizedContainer" class="music-grid">
                <!-- Personalized recommendations will be loaded here -->
            </div>
        </div>
        
        <!-- New Releases -->
        <div id="newReleasesSection" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-calendar-star"></i> New Releases You'll Love
                </h2>
                <div class="section-subtitle">
                    Fresh music from artists you listen to
                </div>
            </div>
            
            <div id="newReleasesContainer" class="music-grid">
                <!-- New releases will be loaded here -->
            </div>
        </div>
        
        <!-- Based on Listening History -->
        <div id="basedOnHistorySection" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-history"></i> Based on Your Listening History
                </h2>
                <div class="section-subtitle">
                    Because you listened to similar tracks
                </div>
            </div>
            
            <div id="basedOnHistoryContainer" class="music-grid">
                <!-- History-based recommendations will be loaded here -->
            </div>
        </div>
        
        <!-- Similar Artists -->
        <div id="similarArtistsSection" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-users"></i> Discover Similar Artists
                </h2>
                <div class="section-subtitle">
                    Artists with music similar to your favorites
                </div>
            </div>
            
            <div id="similarArtistsContainer" class="music-grid">
                <!-- Similar artists will be loaded here -->
            </div>
        </div>
        
        <!-- Trending -->
        <div id="trendingSection" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-fire"></i> Trending in Your Network
                </h2>
                <div class="section-subtitle">
                    What people with similar taste are listening to
                </div>
            </div>
            
            <div id="trendingContainer" class="music-grid">
                <!-- Trending recommendations will be loaded here -->
            </div>
        </div>
        
        <!-- Listening Statistics -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i> Your Listening Statistics
            </h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: rgba(0, 219, 222, 0.1); padding: 20px; border-radius: 10px;">
                    <h4><i class="fas fa-headphones"></i> Top Genres</h4>
                    <div id="topGenres" style="margin-top: 10px;">
                        <!-- Top genres will be loaded here -->
                    </div>
                </div>
                
                <div style="background: rgba(252, 0, 255, 0.1); padding: 20px; border-radius: 10px;">
                    <h4><i class="fas fa-user-friends"></i> Favorite Artists</h4>
                    <div id="topArtists" style="margin-top: 10px;">
                        <!-- Top artists will be loaded here -->
                    </div>
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 10px;">
                    <h4><i class="fas fa-clock"></i> Listening Patterns</h4>
                    <div id="listeningPatterns" style="margin-top: 10px;">
                        <!-- Listening patterns will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feedback -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-comment-dots"></i> Help Improve Recommendations
            </h2>
            
            <div style="margin-top: 20px;">
                <p style="color: #888; margin-bottom: 15px;">
                    Rate tracks to help us understand your preferences better:
                </p>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="nav-btn" onclick="rateMoreTracks()">
                        <i class="fas fa-star"></i> Rate More Tracks
                    </button>
                    <button class="nav-btn" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                    <button class="nav-btn" onclick="updatePreferences()">
                        <i class="fas fa-sliders-h"></i> Update Preferences
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Audio Player -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script>
        let userId = localStorage.getItem('userId') || '1';
        let currentMood = 'all';
        let currentSection = 'personalized';
        let recommendations = {
            personalized: [],
            newReleases: [],
            basedOnHistory: [],
            similarArtists: [],
            trending: []
        };
        
        // Load recommendations on page load
        window.onload = function() {
            loadUserProfile();
            loadPersonalizedRecommendations();
            loadListeningStats();
        };
        
        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch(`/api/social/profile/${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    const profile = result.data;
                    document.getElementById('username').textContent = profile.username || 'Music Explorer';
                    document.getElementById('userBio').textContent = profile.bio || 'Lover of all things music';
                    document.getElementById('playCount').textContent = profile.playCount || '0';
                    document.getElementById('trackCount').textContent = profile.trackCount || '0';
                    document.getElementById('ratingCount').textContent = profile.ratingCount || '0';
                    document.getElementById('daysActive').textContent = Math.floor(Math.random() * 30) + 1;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Load personalized recommendations
        async function loadPersonalizedRecommendations() {
            showLoading(true);
            
            try {
                const response = await fetch(`/api/discover/recommendations?userId=${userId}&limit=12`);
                const result = await response.json();
                
                if (result.success) {
                    recommendations.personalized = result.data.recommendations;
                    displayRecommendations(recommendations.personalized, 'personalized');
                    
                    document.getElementById('personalizedExplanation').textContent = 
                        result.data.explanation || 'Based on your listening history';
                    
                    showStatus('Recommendations loaded!', 'success');
                } else {
                    showStatus(`Failed to load recommendations: ${result.message}`, 'error');
                    loadFallbackRecommendations();
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                loadFallbackRecommendations();
            } finally {
                showLoading(false);
            }
        }
        
        // Load fallback recommendations
        async function loadFallbackRecommendations() {
            try {
                // Load trending music as fallback
                const response = await fetch(`/api/discover/trending?userId=${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    recommendations.personalized = result.data;
                    displayRecommendations(result.data, 'personalized');
                    
                    document.getElementById('personalizedExplanation').textContent = 
                        'Based on popular tracks (personalized recommendations coming soon)';
                }
            } catch (error) {
                console.error('Error loading fallback:', error);
            }
        }
        
        // Display recommendations
        function displayRecommendations(tracks, section) {
            const container = document.getElementById(`${section}Container`);
            container.innerHTML = '';
            
            if (!tracks || tracks.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #b3b3b3;">
                        <i class="fas fa-music" style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3 style="margin-bottom: 10px;">No recommendations yet</h3>
                        <p>Listen to more music to get personalized recommendations.</p>
                    </div>
                `;
                return;
            }
            
            tracks.forEach((track, index) => {
                const musicCard = document.createElement('div');
                musicCard.className = 'music-card';
                
                // Format duration
                const duration = track.duration || 180;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const formattedDuration = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Get album art
                const albumArt = track.albumArt || 'https://via.placeholder.com/300/00DBDE/ffffff?text=Music';
                
                musicCard.innerHTML = `
                    <div class="album-art">
                        <img src="${albumArt}" alt="${track.title || 'Album Art'}" 
                             onerror="this.src='https://via.placeholder.com/300/00DBDE/ffffff?text=Music'">
                        
                        <div class="recommendation-badge">
                            ${Math.round((track.confidenceScore || 0.8) * 100)}% Match
                        </div>
                        
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 20px; font-size: 12px;">
                            ${formattedDuration}
                        </div>
                    </div>
                    
                    <div class="music-info">
                        <div class="music-title" title="${track.title || 'Unknown Track'}">
                            ${track.title || 'Unknown Track'}
                        </div>
                        
                        <div class="music-artist" title="${track.artist || 'Unknown Artist'}">
                            ${track.artist || 'Unknown Artist'}
                        </div>
                        
                        <div class="recommendation-reason">
                            <i class="fas fa-lightbulb"></i> ${track.recommendationReason || 'Recommended for you'}
                        </div>
                        
                        <div class="confidence-score">
                            ${Math.round((track.confidenceScore || 0.8) * 100)}% match
                        </div>
                        
                        <div class="music-meta">
                            <span>${track.genre || 'Unknown'}</span>
                            <span>${track.year || 'Unknown'}</span>
                        </div>
                        
                        <div class="music-actions">
                            <button class="action-btn play-btn" onclick="playTrack('${section}', ${index})">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button class="action-btn add-btn" onclick="addToPlaylist('${section}', ${index})">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button class="action-btn add-btn" onclick="rateTrack('${section}', ${index})">
                                <i class="fas fa-star"></i> Rate
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(musicCard);
            });
        }
        
        // Filter by mood
        function filterByMood(mood) {
            currentMood = mood;
            
            // Update active button
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter recommendations based on mood
            let filteredTracks = [];
            
            switch (mood) {
                case 'happy':
                    filteredTracks = recommendations[currentSection].filter(track => 
                        track.genre && ['pop', 'disco', 'reggae', 'soca'].includes(track.genre.toLowerCase()));
                    break;
                case 'energetic':
                    filteredTracks = recommendations[currentSection].filter(track => 
                        track.genre && ['rock', 'electronic', 'hiphop', 'metal'].includes(track.genre.toLowerCase()));
                    break;
                case 'relaxed':
                    filteredTracks = recommendations[currentSection].filter(track => 
                        track.genre && ['jazz', 'classical', 'ambient', 'chill'].includes(track.genre.toLowerCase()));
                    break;
                case 'focused':
                    filteredTracks = recommendations[currentSection].filter(track => 
                        track.genre && ['classical', 'instrumental', 'lofi', 'study'].includes(track.genre.toLowerCase()));
                    break;
                case 'romantic':
                    filteredTracks = recommendations[currentSection].filter(track => 
                        track.genre && ['rnb', 'soul', 'love songs', 'ballads'].includes(track.genre.toLowerCase()));
                    break;
                case 'workout':
                    filteredTracks = recommendations[currentSection].filter(track => 
                        track.genre && ['hiphop', 'edm', 'rock', 'workout'].includes(track.genre.toLowerCase()));
                    break;
                default:
                    filteredTracks = recommendations[currentSection];
            }
            
            // If no filtered tracks, show all
            if (filteredTracks.length === 0) {
                filteredTracks = recommendations[currentSection];
                showStatus(`No ${mood} mood tracks found. Showing all recommendations.`, 'info');
            }
            
            displayRecommendations(filteredTracks, currentSection);
        }
        
        // Show section
        async function showSection(section) {
            currentSection = section;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all sections
            document.getElementById('personalizedSection').style.display = 'none';
            document.getElementById('newReleasesSection').style.display = 'none';
            document.getElementById('basedOnHistorySection').style.display = 'none';
            document.getElementById('similarArtistsSection').style.display = 'none';
            document.getElementById('trendingSection').style.display = 'none';
            
            // Show selected section
            document.getElementById(`${section}Section`).style.display = 'block';
            
            // Load section data if not already loaded
            if (recommendations[section].length === 0) {
                await loadSectionData(section);
            }
            
            // Apply current mood filter
            filterByMood(currentMood);
        }
        
        // Load section data
        async function loadSectionData(section) {
            showLoading(true);
            
            try {
                let response;
                switch (section) {
                    case 'newReleases':
                        response = await fetch(`/api/discover/search?query=2023&sort=newest&limit=12`);
                        break;
                    case 'basedOnHistory':
                        response = await fetch(`/api/discover/recommendations?userId=${userId}&limit=12`);
                        break;
                    case 'similarArtists':
                        response = await fetch(`/api/discover/search?query=similar&limit=12`);
                        break;
                    case 'trending':
                        response = await fetch(`/api/discover/trending?userId=${userId}&limit=12`);
                        break;
                    default:
                        return;
                }
                
                const result = await response.json();
                if (result.success) {
                    recommendations[section] = result.data.recommendations || result.data;
                    displayRecommendations(recommendations[section], section);
                }
            } catch (error) {
                console.error(`Error loading ${section}:`, error);
                showStatus(`Failed to load ${section}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Load listening statistics
        async function loadListeningStats() {
            try {
                // Mock data for demo
                const topGenres = [
                    { name: 'Pop', percentage: 35 },
                    { name: 'Rock', percentage: 25 },
                    { name: 'Hip-Hop', percentage: 20 },
                    { name: 'Jazz', percentage: 15 },
                    { name: 'Electronic', percentage: 5 }
                ];
                
                const topArtists = [
                    { name: 'The Weeknd', playCount: 42 },
                    { name: 'Taylor Swift', playCount: 38 },
                    { name: 'Kendrick Lamar', playCount: 35 },
                    { name: 'Dua Lipa', playCount: 28 },
                    { name: 'Arctic Monkeys', playCount: 25 }
                ];
                
                const patterns = [
                    { time: 'Morning', percentage: 20 },
                    { time: 'Afternoon', percentage: 35 },
                    { time: 'Evening', percentage: 40 },
                    { time: 'Night', percentage: 5 }
                ];
                
                displayTopGenres(topGenres);
                displayTopArtists(topArtists);
                displayListeningPatterns(patterns);
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Display top genres
        function displayTopGenres(genres) {
            const container = document.getElementById('topGenres');
            container.innerHTML = '';
            
            genres.forEach(genre => {
                const genreItem = document.createElement('div');
                genreItem.style.marginBottom = '10px';
                genreItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${genre.name}</span>
                        <span>${genre.percentage}%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                        <div style="width: ${genre.percentage}%; height: 100%; background: linear-gradient(90deg, #00DBDE, #FC00FF); border-radius: 3px;"></div>
                    </div>
                `;
                container.appendChild(genreItem);
            });
        }
        
        // Display top artists
        function displayTopArtists(artists) {
            const container = document.getElementById('topArtists');
            container.innerHTML = '';
            
            artists.forEach(artist => {
                const artistItem = document.createElement('div');
                artistItem.style.marginBottom = '10px';
                artistItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #00DBDE, #FC00FF); display: flex; align-items: center; justify-content: center;">
                            ${artist.name.charAt(0)}
                        </div>
                        <span style="flex: 1;">${artist.name}</span>
                        <span style="color: #00DBDE;">${artist.playCount} plays</span>
                    </div>
                `;
                container.appendChild(artistItem);
            });
        }
        
        // Display listening patterns
        function displayListeningPatterns(patterns) {
            const container = document.getElementById('listeningPatterns');
            container.innerHTML = '';
            
            patterns.forEach(pattern => {
                const patternItem = document.createElement('div');
                patternItem.style.marginBottom = '10px';
                patternItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span><i class="far fa-clock"></i> ${pattern.time}</span>
                        <span>${pattern.percentage}%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                        <div style="width: ${pattern.percentage}%; height: 100%; background: #FFC107; border-radius: 3px;"></div>
                    </div>
                `;
                container.appendChild(patternItem);
            });
        }
        
        // Play track
        function playTrack(section, index) {
            const track = recommendations[section][index];
            const audioPlayer = document.getElementById('audioPlayer');
            
            // Get audio URL (use sample URL for demo)
            const audioUrl = track.audioUrl || track.sampleAudioUrl || 
                            `https://www.soundhelix.com/examples/mp3/SoundHelix-Song-${(index % 10) + 1}.mp3`;
            
            audioPlayer.src = audioUrl;
            audioPlayer.play();
            
            // Record play history
            fetch('/api/discover/play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-Id': userId
                },
                body: JSON.stringify({
                    audioId: track.id,
                    duration: track.duration || 180
                })
            });
            
            showStatus(`Now playing: ${track.title} by ${track.artist}`, 'success');
        }
        
        // Add to playlist
        function addToPlaylist(section, index) {
            const track = recommendations[section][index];
            const playlistName = prompt('Enter playlist name (or create new):', 'My Favorites');
            
            if (playlistName) {
                showStatus(`Added "${track.title}" to "${playlistName}"`, 'success');
            }
        }
        
        // Rate track
        function rateTrack(section, index) {
            const track = recommendations[section][index];
            const rating = prompt(`Rate "${track.title}" (1-5 stars):`, '5');
            
            if (rating && rating >= 1 && rating <= 5) {
                const review = prompt('Add a review (optional):');
                
                fetch('/api/social/ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': userId
                    },
                    body: JSON.stringify({
                        trackId: track.id,
                        rating: parseFloat(rating),
                        review: review || ''
                    })
                }).then(() => {
                    showStatus('Rating submitted! Recommendations will improve.', 'success');
                });
            }
        }
        
        // Refresh recommendations
        function refreshRecommendations() {
            showLoading(true);
            showStatus('Refreshing recommendations...', 'info');
            
            setTimeout(() => {
                loadPersonalizedRecommendations();
                showStatus('Recommendations refreshed!', 'success');
            }, 1500);
        }
        
        // Rate more tracks
        function rateMoreTracks() {
            alert('Navigate to Discover page to rate more tracks and improve recommendations!');
            window.location.href = '/discover.html';
        }
        
        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear your listening history? This will reset your recommendations.')) {
                showStatus('Clearing history...', 'info');
                // In production, call API to clear history
                setTimeout(() => {
                    showStatus('History cleared. New recommendations will be based on fresh data.', 'success');
                    loadPersonalizedRecommendations();
                }, 2000);
            }
        }
        
        // Update preferences
        function updatePreferences() {
            const genres = prompt('Enter your favorite genres (comma-separated):', 'Pop, Rock, Jazz');
            const artists = prompt('Enter your favorite artists (comma-separated):', 'The Weeknd, Taylor Swift');
            
            if (genres || artists) {
                showStatus('Preferences updated! Refreshing recommendations...', 'success');
                setTimeout(() => {
                    refreshRecommendations();
                }, 1000);
            }
        }
        
        // Helper functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>